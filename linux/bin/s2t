#!/usr/bin/env bash
set -euo pipefail

# Simple toggle dictation: run once to start recording, run again to stop,
# transcribe with Whisper, and paste into the focused app.

STATE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/s2t"
STATE_FILE="$STATE_DIR/state"
TMP_DIR="${S2T_TMP_DIR:-${XDG_RUNTIME_DIR:-/tmp}/s2t}"
mkdir -p "$STATE_DIR" "$TMP_DIR"

S2T_MODEL="${S2T_MODEL:-base}"
S2T_LANG="${S2T_LANG:-}"
S2T_CPP_MODEL="${S2T_CPP_MODEL:-}"
S2T_RECORD_TOOL="${S2T_RECORD_TOOL:-}"
S2T_TERMINAL_CLASSES="${S2T_TERMINAL_CLASSES:-st,alacritty,kitty,xterm,urxvt,wezterm,foot,gnome-terminal,konsole,tilix,termite,xfce4-terminal,lxterminal,qterminal}"
S2T_NOTIFY_SUMMARY="${S2T_NOTIFY_SUMMARY:-s2t}"
S2T_NOTIFY_BODY="${S2T_NOTIFY_BODY:-Recording... (run again to stop)}"
S2T_NOTIFY_STACK_TAG="${S2T_NOTIFY_STACK_TAG:-s2t}"
S2T_MAX_SECONDS="${S2T_MAX_SECONDS:-300}"
S2T_CLIPBOARD="${S2T_CLIPBOARD:-clipboard}"
S2T_CLIPBOARD_RESTORE_DELAY="${S2T_CLIPBOARD_RESTORE_DELAY:-0.15}"

log() { printf 's2t: %s\n' "$*" >&2; }
die() { log "$*"; exit 1; }

have() { command -v "$1" >/dev/null 2>&1; }

notify_start() {
  if have dunstify; then
    dunstify -a "s2t" -p -t 0 -h "string:x-dunst-stack-tag:${S2T_NOTIFY_STACK_TAG}" \
      "$S2T_NOTIFY_SUMMARY" "$S2T_NOTIFY_BODY" 2>/dev/null || true
  elif have notify-send; then
    notify-send -a "s2t" -p -t 0 -h "string:x-dunst-stack-tag:${S2T_NOTIFY_STACK_TAG}" \
      "$S2T_NOTIFY_SUMMARY" "$S2T_NOTIFY_BODY" 2>/dev/null || true
  fi
}

notify_end() {
  local id="${1:-}"
  [[ -n "$id" ]] || return 0
  if have dunstctl; then
    dunstctl close "$id" >/dev/null 2>&1 || true
  else
    # Best-effort replacement with a short timeout.
    notify-send -a "s2t" -r "$id" -t 1 "$S2T_NOTIFY_SUMMARY" "Stopped" >/dev/null 2>&1 || true
  fi
}

pick_record_tool() {
  if [[ -n "$S2T_RECORD_TOOL" ]]; then
    echo "$S2T_RECORD_TOOL"
    return
  fi
  if have pw-record; then
    echo "pw-record"
  elif have arecord; then
    echo "arecord"
  elif have ffmpeg; then
    echo "ffmpeg"
  else
    echo ""
  fi
}

start_record() {
  local wav="$1"
  local tool
  tool="$(pick_record_tool)"
  local rec_pid=""
  case "$tool" in
    pw-record)
      # PipeWire (recommended)
      pw-record --rate 16000 --channels 1 --format s16 "$wav" &
      rec_pid=$!
      ;;
    arecord)
      # ALSA
      arecord -q -f S16_LE -r 16000 -c 1 "$wav" &
      rec_pid=$!
      ;;
    ffmpeg)
      # PulseAudio/ PipeWire via Pulse compat
      ffmpeg -y -f pulse -i default -ac 1 -ar 16000 "$wav" >/dev/null 2>&1 &
      rec_pid=$!
      ;;
    *)
      die "no recording tool found (need pw-record, arecord, or ffmpeg)"
      ;;
  esac
  local timer_pid=""
  if [[ "$S2T_MAX_SECONDS" =~ ^[0-9]+$ ]] && (( S2T_MAX_SECONDS > 0 )); then
    (
      sleep "$S2T_MAX_SECONDS"
      kill -INT "$rec_pid" 2>/dev/null || true
    ) &
    timer_pid=$!
  fi
  echo "$rec_pid" > "$STATE_FILE"
  printf '%s\n' "$wav" >> "$STATE_FILE"
  local nid=""
  nid="$(notify_start)"
  printf '%s\n' "$nid" >> "$STATE_FILE"
  printf '%s\n' "$timer_pid" >> "$STATE_FILE"
}

stop_record() {
  local pid="$1"
  if kill -0 "$pid" 2>/dev/null; then
    kill -INT "$pid" 2>/dev/null || true
    wait "$pid" 2>/dev/null || true
  fi
}

transcribe_whisper_py() {
  local wav="$1"
  local outdir="$TMP_DIR/whisper-$(date +%s)"
  mkdir -p "$outdir"
  local args=("$wav" --model "$S2T_MODEL" --output_format txt --output_dir "$outdir")
  if [[ -n "$S2T_LANG" ]]; then
    args+=(--language "$S2T_LANG")
  fi
  whisper "${args[@]}" >/dev/null 2>&1
  local txt="$outdir/$(basename "${wav%.*}").txt"
  [[ -f "$txt" ]] || die "whisper output missing: $txt"
  cat "$txt"
}

transcribe_whisper_cpp() {
  local wav="$1"
  [[ -n "$S2T_CPP_MODEL" ]] || die "S2T_CPP_MODEL must be set for whisper.cpp"
  [[ -f "$S2T_CPP_MODEL" ]] || die "S2T_CPP_MODEL not found: $S2T_CPP_MODEL"
  local stamp
  stamp="$(date +%s)"
  local outprefix="$TMP_DIR/whispercpp-$stamp"
  local logfile="$TMP_DIR/whispercpp-$stamp.log"
  local args=(-m "$S2T_CPP_MODEL" -f "$wav" -otxt -of "$outprefix")
  if [[ -n "$S2T_LANG" ]]; then
    args+=(-l "$S2T_LANG")
  fi
  if have whisper-cli; then
    whisper-cli "${args[@]}" >"$logfile" 2>&1 || {
      tail -n 50 "$logfile" >&2 || true
      die "whisper.cpp failed (see log above)"
    }
  else
    main "${args[@]}" >"$logfile" 2>&1 || {
      tail -n 50 "$logfile" >&2 || true
      die "whisper.cpp failed (see log above)"
    }
  fi
  local txt="${outprefix}.txt"
  [[ -f "$txt" ]] || {
    tail -n 50 "$logfile" >&2 || true
    die "whisper.cpp output missing: $txt"
  }
  rm -f "$logfile" >/dev/null 2>&1 || true
  cat "$txt"
}

transcribe() {
  local wav="$1"
  if have whisper; then
    transcribe_whisper_py "$wav"
  elif have whisper-cli || have main; then
    transcribe_whisper_cpp "$wav"
  else
    die "no whisper CLI found (install openai-whisper or whisper.cpp)"
  fi
}

is_terminal_focused_x11() {
  have xdotool || return 1
  local wid class
  wid="$(xdotool getwindowfocus 2>/dev/null)" || return 1
  class="$(xdotool getwindowclassname "$wid" 2>/dev/null || true)"
  class="${class,,}"
  [[ -z "$class" ]] && return 1
  local IFS=',' entry
  for entry in $S2T_TERMINAL_CLASSES; do
    entry="${entry,,}"
    if [[ "$class" == "$entry" ]]; then
      return 0
    fi
  done
  return 1
}

clipboard_save_x11() {
  local out="$1"
  if have xclip; then
    xclip -selection clipboard -o >"$out" 2>/dev/null || return 1
    return 0
  fi
  if have xsel; then
    xsel --clipboard --output >"$out" 2>/dev/null || return 1
    return 0
  fi
  return 1
}

clipboard_restore_x11() {
  local in="$1"
  if have xclip; then
    xclip -selection clipboard <"$in" 2>/dev/null || return 1
    return 0
  fi
  if have xsel; then
    xsel --clipboard --input <"$in" 2>/dev/null || return 1
    return 0
  fi
  return 1
}

clipboard_save_wayland() {
  local out="$1"
  if have wl-paste; then
    wl-paste >"$out" 2>/dev/null || return 1
    return 0
  fi
  return 1
}

clipboard_restore_wayland() {
  local in="$1"
  if have wl-copy; then
    wl-copy <"$in" 2>/dev/null || return 1
    return 0
  fi
  return 1
}

paste_text_wayland() {
  local text="$1"
  local savefile=""
  local saved=0
  if [[ "$S2T_CLIPBOARD" == "preserve" ]]; then
    savefile="$TMP_DIR/clip-$$"
    if clipboard_save_wayland "$savefile"; then
      saved=1
    else
      log "could not save clipboard; proceeding"
    fi
  fi
  if have wl-copy; then
    printf '%s' "$text" | wl-copy
    if have wtype; then
      wtype -M ctrl v
      if (( saved )); then
        sleep "$S2T_CLIPBOARD_RESTORE_DELAY"
        clipboard_restore_wayland "$savefile" || true
        rm -f "$savefile" || true
      fi
      return 0
    fi
    if have ydotool; then
      # Ctrl+V (requires ydotoold running)
      ydotool key 29:1 47:1 47:0 29:0
      if (( saved )); then
        sleep "$S2T_CLIPBOARD_RESTORE_DELAY"
        clipboard_restore_wayland "$savefile" || true
        rm -f "$savefile" || true
      fi
      return 0
    fi
    log "clipboard set, but no Wayland paste tool found (install wtype or ydotool)"
    if (( saved )); then
      clipboard_restore_wayland "$savefile" || true
      rm -f "$savefile" || true
    fi
    return 0
  fi
  return 1
}

paste_text_x11() {
  local text="$1"
  local savefile=""
  local saved=0
  if [[ "$S2T_CLIPBOARD" == "preserve" ]]; then
    savefile="$TMP_DIR/clip-$$"
    if clipboard_save_x11 "$savefile"; then
      saved=1
    else
      log "could not save clipboard; proceeding"
    fi
  fi
  if have xclip; then
    printf '%s' "$text" | xclip -selection clipboard
    if have xdotool; then
      if is_terminal_focused_x11; then
        xdotool key --clearmodifiers ctrl+shift+v
      else
        xdotool key --clearmodifiers ctrl+v
      fi
      if (( saved )); then
        sleep "$S2T_CLIPBOARD_RESTORE_DELAY"
        clipboard_restore_x11 "$savefile" || true
        rm -f "$savefile" || true
      fi
      return 0
    fi
    log "clipboard set, but no X11 paste tool found (install xdotool)"
    if (( saved )); then
      clipboard_restore_x11 "$savefile" || true
      rm -f "$savefile" || true
    fi
    return 0
  fi
  if have xsel; then
    printf '%s' "$text" | xsel --clipboard --input
    if have xdotool; then
      if is_terminal_focused_x11; then
        xdotool key --clearmodifiers ctrl+shift+v
      else
        xdotool key --clearmodifiers ctrl+v
      fi
      if (( saved )); then
        sleep "$S2T_CLIPBOARD_RESTORE_DELAY"
        clipboard_restore_x11 "$savefile" || true
        rm -f "$savefile" || true
      fi
      return 0
    fi
    log "clipboard set, but no X11 paste tool found (install xdotool)"
    if (( saved )); then
      clipboard_restore_x11 "$savefile" || true
      rm -f "$savefile" || true
    fi
    return 0
  fi
  return 1
}

paste_text() {
  local text="$1"
  if [[ -n "${WAYLAND_DISPLAY:-}" ]]; then
    if paste_text_wayland "$text"; then
      return 0
    fi
  fi
  if [[ -n "${DISPLAY:-}" ]]; then
    if paste_text_x11 "$text"; then
      return 0
    fi
  fi
  # Fallback: just print and copy if possible
  log "auto-paste not available; printing transcription to stdout"
  printf '%s' "$text"
}

if [[ -f "$STATE_FILE" ]]; then
  read -r pid < "$STATE_FILE" || true
  read -r wav < <(sed -n '2p' "$STATE_FILE") || true
  read -r nid < <(sed -n '3p' "$STATE_FILE") || true
  read -r timer < <(sed -n '4p' "$STATE_FILE") || true

  if [[ -n "${timer:-}" ]]; then
    kill "$timer" 2>/dev/null || true
    wait "$timer" 2>/dev/null || true
  fi
  if [[ -n "${pid:-}" ]]; then
    stop_record "$pid"
  fi
  notify_end "$nid"
  rm -f "$STATE_FILE"

  if [[ -z "${wav:-}" || ! -f "$wav" ]]; then
    die "recording file missing"
  fi
  if [[ ! -s "$wav" ]]; then
    die "recording file is empty"
  fi

  text="$(transcribe "$wav")"
  # Skip empty/silence output without altering the text.
  check="$(printf '%s' "$text" | tr -d '[:space:]')"
  if [[ -z "$check" ]]; then
    exit 0
  fi
  paste_text "$text"
  exit 0
fi

wav="$TMP_DIR/rec-$(date +%Y%m%d-%H%M%S).wav"
start_record "$wav"
log "recording started (run again to stop)"
